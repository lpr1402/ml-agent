// Schema Multi-Tenant ML Agent SaaS
// Autentica√ß√£o PRINCIPAL via Mercado Livre OAuth
// Suporte para m√∫ltiplas contas ML por organiza√ß√£o

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["tracing"]
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== ORGANIZA√á√ÉO (Baseada na conta ML principal) ==========

model Organization {
  id                 String             @id @default(cuid())

  // Sistema de login com PIN
  username           String?            @unique // Nome de usu√°rio para login
  pinHash            String?            // PIN de 3 d√≠gitos (hash)
  organizationName   String?            // Nome da organiza√ß√£o

  // Conta ML principal (owner) - opcional at√© o primeiro login
  primaryMLAccountId String?            @unique
  primaryMLUserId    String?            @unique
  primaryNickname    String?
  primaryEmail       String?
  primarySiteId      String?            // MLB, MLA, MLM

  // üéØ Configura√ß√µes de contato e notifica√ß√µes
  whatsappNumber         String?        // N√∫mero WhatsApp para notifica√ß√µes
  emailNotifications     Boolean        @default(true) // Receber notifica√ß√µes por email
  whatsappNotifications  Boolean        @default(true) // Receber notifica√ß√µes por WhatsApp

  // Assinatura
  plan               PlanType           @default(FREE)
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  subscriptionEndsAt DateTime?
  trialEndsAt        DateTime           @default(dbgenerated("NOW() + INTERVAL '7 days'"))

  // üéØ ADMIN: Role system
  role               OrganizationRole   @default(CLIENT)

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Relations
  mlAccounts       MLAccount[]
  sessions         Session[]
  auditLogs        AuditLog[]
  payments         Payment[]
  webhookEvents    WebhookEvent[]
  approvalTokens   ApprovalToken[]
  pushSubscriptions PushSubscription[]
  fullStockSnapshots FullStockSnapshot[]
  alerts           Alert[]

  @@index([primaryMLUserId])
  @@index([subscriptionStatus])
  @@index([role])
}

// ========== CONTAS ML (M√∫ltiplas por organiza√ß√£o) ==========

model MLAccount {
  id              String   @id @default(cuid())
  mlUserId        String   @unique
  nickname        String
  email           String?
  siteId          String   // MLB, MLA, MLM
  permalink       String?
  thumbnail       String?
  
  // Indica se √© a conta prim√°ria
  isPrimary       Boolean  @default(false)
  
  // Tokens criptografados (AES-256-GCM)
  accessTokenIV   String   
  accessTokenTag  String   
  accessToken     String   
  refreshTokenIV  String
  refreshTokenTag String
  refreshToken    String   
  tokenExpiresAt  DateTime
  
  // Rate limiting (erro 429)
  rateLimitReset  DateTime?
  rateLimitCount  Int      @default(0)
  lastRequestAt   DateTime?
  
  // Organiza√ß√£o
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Status
  isActive        Boolean  @default(true)
  lastSyncAt      DateTime?
  connectionError String?

  // Seller info cache (JSON completo)
  sellerReputation Json?
  powerSellerStatus String?

  // üî• ENTERPRISE: Profile sync metadata
  lastProfileSync           DateTime? // √öltima vez que /users/me foi chamado
  sellerReputationLevel     String?   // red, orange, yellow, light_green, green
  sellerTransactionsCompleted Int?    // Total de transa√ß√µes completadas
  sellerTransactionsCanceled  Int?    // Total de transa√ß√µes canceladas
  isPowerSeller             Boolean   @default(false) // platinum, gold = true

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  questions       Question[]
  metrics         MLMetrics[]
  webhooks        WebhookEvent[]
  approvalTokens  ApprovalToken[]
  fullStockSnapshots FullStockSnapshot[]
  orders          Order[] // üéØ Vendas da conta
  alerts          Alert[]
  xpTracking      MLAccountXP? // üéÆ Sistema de XP/Ranking

  @@index([organizationId])
  @@index([mlUserId])
  @@index([isPrimary])
}

// ========== SESS√ïES (Login via ML OAuth) ==========

model Session {
  id             String   @id @default(cuid())
  sessionToken   String   @unique
  
  // Vinculado √† organiza√ß√£o (via conta ML principal)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Conta ML ativa na sess√£o (pode alternar)
  activeMLAccountId String?
  
  expiresAt      DateTime
  ipAddress      String?
  userAgent      String?
  lastActivityAt DateTime @default(now())
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([sessionToken])
  @@index([organizationId])
}

// ========== OAUTH STATE (PKCE) ==========

model OAuthState {
  id             String   @id @default(cuid())
  state          String   @unique
  codeVerifier   String   // PKCE
  
  // Para adicionar nova conta ML
  organizationId String?  // Null no primeiro login
  isPrimaryLogin Boolean  @default(false)
  
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  
  @@index([state])
  @@index([expiresAt])
}

// ========== TOKEN BACKUP REMOVIDO - Agora usa MLAccount ==========
// Todos os tokens s√£o gerenciados atrav√©s do modelo MLAccount
// com criptografia AES-256-GCM para seguran√ßa

// ========== M√âTRICAS ML ==========

model MLMetrics {
  id          String    @id @default(cuid())
  mlAccountId String
  mlAccount   MLAccount @relation(fields: [mlAccountId], references: [id], onDelete: Cascade)
  
  date        DateTime  
  metricType  String    // SALES, VISITS, CONVERSION, REPUTATION
  metricName  String    // total_sales, pending_sales, etc
  value       Float
  period      String    // day, week, month
  
  metadata    Json?     // Dados extras
  
  createdAt   DateTime  @default(now())
  
  @@unique([mlAccountId, date, metricType, metricName])
  @@index([mlAccountId, date])
}

// ========== USER METRICS (Cache) ==========

model UserMetrics {
  id              String   @id @default(cuid())
  mlUserId        String   @unique  // ML User ID do vendedor
  
  // M√©tricas de Perguntas
  totalQuestions  Int      @default(0)
  answeredQuestions Int    @default(0)
  pendingQuestions Int     @default(0)
  answeredToday   Int      @default(0)
  avgResponseTime Float    @default(0)
  
  // M√©tricas de Qualidade
  autoApprovedCount   Int  @default(0)
  manualApprovedCount Int  @default(0)
  revisedCount        Int  @default(0)
  rejectedCount       Int  @default(0)
  failedQuestions     Int  @default(0)
  
  // Gamifica√ß√£o e XP
  totalXP         Int      @default(0)
  currentLevel    Int      @default(1)
  currentStreak   Int      @default(0)
  maxStreak       Int      @default(0)
  achievements    Json[]   @default([])
  lastXPUpdate    DateTime?
  
  // Timestamps
  lastQuestionAt  DateTime?
  lastActiveAt    DateTime?
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
  
  @@index([mlUserId])
}

// ========== PERGUNTAS DO ML ==========

model Question {
  id            String    @id @default(cuid())
  mlQuestionId  String    @unique
  mlAccountId   String
  mlAccount     MLAccount @relation(fields: [mlAccountId], references: [id], onDelete: Cascade)
  
  // Dados do item/produto
  itemId        String
  itemTitle     String?
  itemPrice     Float?    @default(0)
  itemPermalink String?   // Link do produto no ML
  itemThumbnail String?   // URL da imagem do produto
  
  // Dados da pergunta
  sellerId      String    // ID do vendedor no ML
  customerId    String?   // ID do cliente que perguntou
  text          String    @db.Text

  // ID sequencial √∫nico (formato XX/DDMM)
  sequentialId  String?   // ID √∫nico gerado uma vez para rastreio
  
  // Status e timestamps cr√≠ticos
  status        String    @default("RECEIVED") // Estados do sistema
  dateCreated   DateTime  // Data que o ML criou a pergunta
  receivedAt    DateTime  @default(now()) // Quando n√≥s recebemos
  sentToAIAt    DateTime? // Quando enviamos para o n8n/IA processar

  // Processamento IA
  aiSuggestion  String?   @db.Text // Sugest√£o da IA
  aiConfidence  Float?    // Confian√ßa da IA (0-1)
  aiProcessedAt DateTime? // Quando a IA processou
  processedAt   DateTime? // Alias para compatibilidade

  // Respostas editadas/revisadas
  editedResponse String?  @db.Text // Resposta editada manualmente (antes de aprovar)
  finalResponse  String?  @db.Text // Resposta final que ser√° enviada

  // Resposta final e envio
  answer        String?   @db.Text // Resposta final aprovada
  answeredAt    DateTime? // Quando foi respondida
  answeredBy    String?   // AI_AUTO, AI_REVISED, MANUAL
  approvalType  String?   // AUTO, MANUAL, REVISED
  approvedAt    DateTime? // Quando foi aprovada
  
  // Tracking de envio ao ML
  sentToMLAt    DateTime? // Quando enviamos ao ML
  mlResponseCode Int?     // C√≥digo de resposta do ML
  mlResponseData Json?    // Dados da resposta do ML
  
  // Controle de falhas
  failedAt      DateTime? // Quando falhou
  failureReason String?   // Motivo da falha
  retryCount    Int       @default(0) // Tentativas de reenvio

  // Tracking de notifica√ß√µes
  whatsappSentAt   DateTime? // Quando notifica√ß√£o WhatsApp foi enviada
  whatsappSentTo   String?   // N√∫mero que recebeu notifica√ß√£o
  browserNotified  Boolean   @default(false) // Se notifica√ß√£o browser foi enviada
  notificationError String?  // Erro ao enviar notifica√ß√£o

  // Performance tracking
  responseTimeMs   Int?      // Tempo de resposta em ms
  processingTimeMs Int?      // Tempo de processamento IA em ms

  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // üéØ ROI TRACKING - Convers√£o de perguntas em vendas
  hasConversion   Boolean  @default(false) // Se essa pergunta gerou venda
  convertedAt     DateTime? // Quando a convers√£o aconteceu
  conversionValue Float?    @default(0) // Valor da venda gerada (R$)

  // Relations
  revisions     Revision[]
  approvalTokens ApprovalToken[]
  conversions   OrderConversion[] // Vendas geradas por essa pergunta

  // √çndices otimizados para m√°xima performance
  @@index([mlAccountId, status])
  @@index([mlQuestionId])
  @@index([dateCreated])
  @@index([receivedAt])
  @@index([status])
  @@index([sellerId, status, dateCreated]) // Query de m√©tricas
  @@index([mlAccountId, dateCreated]) // Hist√≥rico por conta
  @@index([status, answeredAt]) // An√°lise de performance
  @@index([customerId, sellerId]) // üéØ CRUCIAL para tracking de convers√£o
  @@index([hasConversion]) // Filtrar perguntas que converteram
}

// ========== REVIS√ïES ==========

model Revision {
  id           String   @id @default(cuid())
  questionId   String
  question     Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // Campos essenciais para revis√£o
  userFeedback String   @db.Text  // Feedback do usu√°rio solicitando revis√£o
  aiRevision   String   @db.Text  // Resposta revisada pela IA

  createdAt    DateTime @default(now())

  @@index([questionId])
}

// ========== PAGAMENTOS ==========

model Payment {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  amount         Float         @default(500.00)
  currency       String        @default("BRL")
  method         PaymentMethod @default(PIX)
  
  // PIX Info Hardcoded
  pixCode        String?       @default("00020101021126330014br.gov.bcb.pix0111496118808555204000053039865406500.005802BR5925LUIS FERNANDO PEREIRA ROD6009SAO PAULO622905251K3PC743YN7DR3JGS3EXE3RPW630449B9") @db.Text
  pixKey         String?       @default("496118808-55")
  pixQRUrl       String?       @default("https://www.dropbox.com/scl/fi/r6zrsjvz2pbo6pgc0tlgw/IMG_3881.jpeg?rlkey=yyrtf2n0nz4zt6ogqx2a8870h&st=q3rhjrkk&raw=1")
  
  status         PaymentStatus @default(PENDING)
  paidAt         DateTime?
  confirmedBy    String?       
  
  metadata       Json?
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  @@index([organizationId, status])
}

// ========== WEBHOOKS ==========

model WebhookEvent {
  id             String    @id @default(cuid())
  mlAccountId    String?
  mlAccount      MLAccount? @relation(fields: [mlAccountId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Idempotency key to prevent duplicate processing
  idempotencyKey String    @unique // Unique constraint prevents duplicates
  
  // Campos obrigat√≥rios para webhooks
  eventType      String    @default("questions") // tipo do evento
  eventId        String?   // ID do evento espec√≠fico (opcional para nossos eventos)
  topic          String?   // questions, orders, items, messages (opcional para nossos eventos)
  resourceId     String
  resourceUrl    String?   // URL do recurso afetado
  userId         String?   // ML user ID (opcional para nossos eventos)
  applicationId  String?   // (opcional para nossos eventos)
  attemptId      String?   // (opcional para nossos eventos)
  priority       Int?      @default(0) // Prioridade do evento
  
  // Status do processamento
  status         String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  sentAt         DateTime?
  receivedAt     DateTime  @default(now())
  processed      Boolean   @default(false)
  processedAt    DateTime?
  processingError String?
  error          String?
  createdAt      DateTime  @default(now())
  
  payload        Json
  signature      String?   
  
  @@index([mlAccountId, topic])
  @@index([processed, receivedAt])
  @@index([eventType, eventId])
  @@index([status, receivedAt])
  @@index([idempotencyKey])
  @@index([resourceId, topic])
}

// ========== AUDIT LOG ==========

model AuditLog {
  id             String       @id @default(cuid())
  action         String       // ml_account.connected, payment.confirmed
  entityType     String       
  entityId       String
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  mlAccountId    String?      // Conta ML que executou a a√ß√£o
  
  metadata       Json         
  ipAddress      String?
  userAgent      String?
  
  createdAt      DateTime     @default(now())
  
  @@index([organizationId, createdAt])
  @@index([action, createdAt])
}

// ========== APPROVAL TOKENS (SEGURAN√áA CR√çTICA) ==========
// Sistema de tokens √∫nicos para aprova√ß√£o via WhatsApp
// Garante que cada link s√≥ pode ser usado uma vez

model ApprovalToken {
  id              String       @id @default(cuid())
  
  // Token √∫nico para o link de aprova√ß√£o
  token           String       @unique
  
  // Relacionamento com a pergunta
  questionId      String       
  question        Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  // Conta ML e organiza√ß√£o para isolamento multi-tenant
  mlAccountId     String
  mlAccount       MLAccount    @relation(fields: [mlAccountId], references: [id], onDelete: Cascade)
  
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Controle de uso e expira√ß√£o
  used            Boolean      @default(false)
  usedAt          DateTime?
  expiresAt       DateTime     // Token expira em 24 horas por padr√£o
  
  // Metadata
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  // Informa√ß√µes adicionais
  ipAddress       String?      // IP que criou o token
  userAgent       String?      // User agent do WhatsApp/browser
  approvalType    String?      // QUICK, MANUAL, REVISED
  
  @@index([token])
  @@index([questionId])
  @@index([mlAccountId])
  @@index([organizationId])
  @@index([expiresAt])
  @@index([used])
}

// ========== PUSH SUBSCRIPTIONS (PWA NOTIFICATIONS) ==========
// Armazena inscri√ß√µes de push notifications para PWA
// Permite notifica√ß√µes 24/7 mesmo com app fechado

model PushSubscription {
  id              String       @id @default(cuid())

  // Subscription data do navegador
  endpoint        String       @unique // URL √∫nico do push service
  p256dh          String       // Public key para criptografia
  auth            String       // Auth secret

  // Associa√ß√£o com organiza√ß√£o (multi-tenant)
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Device/Browser info
  deviceName      String?      // Nome customizado do dispositivo
  deviceType      String?      // ios, android, desktop
  browser         String?      // safari, chrome, firefox
  browserVersion  String?
  os              String?      // iOS 16.4+, Android, Windows, macOS

  // Controle de notifica√ß√µes
  isActive        Boolean      @default(true)
  lastUsedAt      DateTime?    // √öltima vez que enviamos push
  failureCount    Int          @default(0) // Contador de falhas

  // Prefer√™ncias do usu√°rio
  enableQuestions Boolean      @default(true)  // Notificar novas perguntas
  enableUrgent    Boolean      @default(true)  // Notificar urgentes
  enableBatch     Boolean      @default(true)  // Agrupar m√∫ltiplas perguntas
  quietHoursStart Int?         // Hora de in√≠cio do sil√™ncio (0-23)
  quietHoursEnd   Int?         // Hora de fim do sil√™ncio (0-23)
  timezone        String       @default("America/Sao_Paulo")

  // Metadata
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([organizationId])
  @@index([isActive])
  @@index([endpoint])
}

// ========== ENUMS ==========

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  CONFIRMED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  BOLETO
}

enum PlanType {
  FREE
  PRO
}

enum OrganizationRole {
  CLIENT
  SUPER_ADMIN
}

// ========== ORDERS (Vendas do Mercado Livre) ==========
// Sistema de tracking de vendas para an√°lise de ROI do ML Agent
// Permite rastrear quais perguntas geraram vendas concretas

model Order {
  id              String   @id @default(cuid())
  mlOrderId       String   @unique // ID da order no ML (ex: 2000003508419013)

  // Relacionamento com conta ML e organiza√ß√£o
  mlAccountId     String
  mlAccount       MLAccount @relation(fields: [mlAccountId], references: [id], onDelete: Cascade)
  organizationId  String

  // üéØ IDs CR√çTICOS para tracking de convers√£o
  sellerId        String   // ID do vendedor no ML
  buyerId         String   // ID do comprador no ML (CHAVE para convers√£o!)

  // Dados financeiros
  totalAmount     Float    @default(0) // Valor total da order
  paidAmount      Float    @default(0) // Valor pago
  currencyId      String   @default("BRL") // Moeda

  // Status da order (seguindo padr√µes ML)
  status          String   // paid, confirmed, cancelled, invalid, etc
  statusDetail    String?  // Detalhe adicional do status

  // Itens da order (JSON array para flexibilidade)
  orderItems      Json     // Array de {item_id, title, quantity, unit_price, sale_fee}

  // Informa√ß√µes de pagamento
  paymentMethod   String?  // credit_card, account_money, pix, etc
  paymentStatus   String?  // approved, pending, rejected, etc

  // Informa√ß√µes de envio
  shippingId      String?  // ID do envio (se houver)
  shippingCost    Float?   @default(0)

  // Datas importantes
  dateCreated     DateTime // Data de cria√ß√£o da order no ML
  dateClosed      DateTime? // Data de confirma√ß√£o/pagamento
  lastUpdated     DateTime @updatedAt // √öltima atualiza√ß√£o

  // üéØ TRACKING DE CONVERS√ÉO - Perguntas relacionadas
  // Relacionamento many-to-many com Question
  conversions     OrderConversion[]

  // Flags de an√°lise
  hasRelatedQuestions Boolean @default(false) // Se tem perguntas vinculadas
  attributedToAgent   Boolean @default(false) // Se foi atribu√≠da ao Agent

  // Metadata completa do ML (para an√°lises futuras e debug)
  mlPayload       Json?    // Payload completo da API /orders/:id

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // √çndices otimizados para queries de ROI
  @@index([mlAccountId, status])
  @@index([organizationId, status])
  @@index([buyerId, sellerId]) // üéØ CRUCIAL para buscar perguntas do buyer
  @@index([dateCreated])
  @@index([dateClosed])
  @@index([status, dateClosed]) // Orders pagas por per√≠odo
  @@index([attributedToAgent, dateClosed]) // Vendas do Agent
  @@index([mlOrderId])
}

// ========== ORDER CONVERSIONS (Link Question ‚Üí Order) ==========
// Tabela de relacionamento many-to-many entre perguntas e vendas
// Permite rastrear exatamente quais perguntas geraram quais vendas

model OrderConversion {
  id            String   @id @default(cuid())

  // Relacionamentos
  questionId    String
  question      Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  orderId       String
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Metadata da convers√£o
  conversionValue Float  @default(0) // Valor da venda
  timeToConversion Int?  // Tempo em minutos entre pergunta e venda

  // Timestamps
  createdAt     DateTime @default(now())

  // Garantir que uma pergunta n√£o seja vinculada duas vezes √† mesma order
  @@unique([questionId, orderId])
  @@index([questionId])
  @@index([orderId])
}

// ========== FULL STOCK SYSTEM (Mercado Full) ==========

model FullStockSnapshot {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  mlAccountId     String
  mlAccount       MLAccount @relation(fields: [mlAccountId], references: [id], onDelete: Cascade)

  // ‚ö†Ô∏è IMPORTANTE - Identificadores ML com comportamento dual:
  //
  // inventoryId pode conter DOIS tipos de valores:
  // 1. Full Puro:       "LCQI05831" (inventory_id tradicional do ML)
  // 2. Full+Flex/Multi: "MLAU12345678" (user_product_id - detect√°vel por regex ML[A-Z]U\d+)
  // 3. Pending:         "PENDING_MLB123456" (tempor√°rio, aguardando recep√ß√£o)
  //
  // Use stockTypeDetector.isValidUserProductId() para distinguir!
  //
  inventoryId     String   // ID √∫nico do Full - PODE SER inventory_id OU user_product_id
  itemId          String   // MLB1234567 (ID do an√∫ncio no marketplace)
  variationId     String?  // Se for varia√ß√£o (ex: cor, tamanho)
  userProductId   String?  // MLAU1234567 (quando Full+Flex ou Multi-Origem)

  // Dados do item (cache para evitar chamadas ML)
  itemTitle       String
  itemThumbnail   String?
  itemPrice       Float    @default(0)
  itemPermalink   String?

  // Estoque Full atual
  totalStock      Int      @default(0)
  availableStock  Int      @default(0)
  notAvailableStock Int    @default(0)
  notAvailableDetail Json? // Array de {status, quantity}

  // An√°lise de vendas (baseado em orders)
  lookbackDays    Int      @default(30)
  totalSales      Int      @default(0)
  avgDailySales   Float    @default(0)
  stdDevSales     Float    @default(0)
  salesTrend      String   @default("stable") // stable | increasing | decreasing

  // Proje√ß√µes e recomenda√ß√µes
  daysOfCover     Float    @default(0)
  stockoutDate    DateTime?
  reorderPoint    Int      @default(0)
  safetyStock     Int      @default(0)
  recommendedQty  Int      @default(0)
  recommendedDate DateTime?

  // Alertas
  alertLevel      String   @default("ok") // critical | warning | ok | unknown
  confidence      Float    @default(0)
  signals         Json     @default("[]") // Array de sinais detectados

  // Configura√ß√£o da an√°lise
  leadTimeDays    Int      @default(7)
  safetyStockDays Int      @default(3)
  serviceLevel    Float    @default(0.90)
  targetDaysOfCover Int    @default(30)

  // Qualidade dos dados
  dataQuality     String   @default("unknown") // high | medium | low | unknown
  lastAnalyzedAt  DateTime @default(now())

  // üöÄ ENTERPRISE: M√©tricas Financeiras Avan√ßadas (Outubro 2025)
  lostRevenue7d       Float    @default(0) // Receita perdida pr√≥ximos 7 dias (se zero)
  lostRevenue30d      Float    @default(0) // Receita perdida pr√≥ximos 30 dias (se zero)
  storageCostMonthly  Float    @default(0) // Custo armazenagem Full (R$/m√™s)
  capitalInvested     Float    @default(0) // Valor investido em estoque
  potentialRevenue7d  Float    @default(0) // Receita potencial 7 dias
  potentialRevenue30d Float    @default(0) // Receita potencial 30 dias
  turnoverRate        Float    @default(0) // Giro de estoque (x/m√™s)
  stockROI            Float    @default(0) // ROI mensal (%)
  sellOutDays         Float    @default(0) // Dias para zerar estoque

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  alerts          StockAlert[]
  operations      StockOperation[]

  // ‚úÖ FIX P2-1: UNIQUE CONSTRAINTS otimizados
  //
  // Constraint 1: Garante um snapshot por inventoryId por organiza√ß√£o
  // (inventoryId pode ser inventory_id OU user_product_id - ver coment√°rio acima)
  @@unique([organizationId, inventoryId])
  //
  // Constraint 2: Garante um snapshot por inventoryId por conta ML
  // Importante: Uma mesma conta pode ter m√∫ltiplos invent√°rios
  @@unique([inventoryId, mlAccountId])
  //
  // √çNDICES DE PERFORMANCE:
  @@index([mlAccountId]) // Queries por conta
  @@index([organizationId, alertLevel]) // Dashboard filtrado
  @@index([daysOfCover]) // Sorting por cobertura
  @@index([lastAnalyzedAt]) // Sync status
  @@index([alertLevel, daysOfCover]) // ‚úÖ NOVO: Filtro + sort combinados
  @@index([organizationId, mlAccountId, alertLevel]) // ‚úÖ NOVO: Query principal do dashboard
  @@map("FullStockSnapshot")
}


// Opera√ß√µes de estoque (hist√≥rico)
model StockOperation {
  id              String   @id @default(cuid())
  snapshotId      String
  snapshot        FullStockSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  // Dados da opera√ß√£o ML
  mlOperationId   String   @unique // ID da opera√ß√£o no ML
  inventoryId     String
  operationType   String   // SALE_CONFIRMATION, INBOUND_RECEPTION, etc
  dateCreated     DateTime // Data da opera√ß√£o no ML

  // Mudan√ßas no estoque
  availableChange Int      // +100 ou -5
  totalChange     Int

  // Detalhes
  detail          Json     // StockOperationDetail original
  result          Json     // StockOperationResult original
  externalRefs    Json     // Array de refer√™ncias (shipment_id, etc)

  createdAt       DateTime @default(now())

  @@index([snapshotId, dateCreated])
  @@index([inventoryId, dateCreated])
  @@index([operationType])
}

// Alertas de estoque
model StockAlert {
  id              String   @id @default(cuid())
  organizationId  String
  snapshotId      String
  snapshot        FullStockSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  // Dados do alerta
  inventoryId     String
  itemId          String
  variationId     String?
  itemTitle       String
  itemThumbnail   String?

  alertLevel      String   // critical | warning | ok
  message         String   @db.Text
  daysOfCover     Float
  currentStock    Int
  recommendedQty  Int
  recommendedDate DateTime?
  recommendedAction String @db.Text

  // Controle de visualiza√ß√£o
  acknowledged    Boolean  @default(false)
  acknowledgedAt  DateTime?
  acknowledgedBy  String?  // User ID ou "AUTO"

  // Snooze
  snoozedUntil    DateTime?
  snoozeReason    String?

  // Notifica√ß√µes enviadas
  notifiedInApp   Boolean  @default(false)
  notifiedEmail   Boolean  @default(false)
  notifiedWhatsApp Boolean @default(false)
  notifiedAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId, alertLevel])
  @@index([snapshotId])
  @@index([inventoryId])
  @@index([itemId])
  @@index([alertLevel, acknowledged])
}

// ========== ADMIN: ALERTS SYSTEM ==========
// Sistema de alertas para painel administrativo
// Monitora sa√∫de de organiza√ß√µes, contas ML, e perguntas

model Alert {
  id              String   @id @default(cuid())

  // Tipo e categoria
  type            AlertType
  category        AlertCategory

  // Contexto
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  mlAccountId     String?
  mlAccount       MLAccount? @relation(fields: [mlAccountId], references: [id], onDelete: Cascade)

  // Detalhes
  message         String   @db.Text
  affectedQuestions Int?
  suggestedAction String   @db.Text
  actionUrl       String?

  // Status
  status          AlertStatus @default(ACTIVE)
  detectedAt      DateTime @default(now())
  resolvedAt      DateTime?
  resolvedBy      String?  // "AUTO" ou admin userId
  dismissedAt     DateTime?
  dismissedBy     String?

  // Metadata
  metadata        Json?    // Dados extras

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status, type])
  @@index([organizationId, status])
  @@index([detectedAt])
  @@index([status, detectedAt])
}

enum AlertType {
  CRITICAL
  WARNING
  INFO
}

enum AlertCategory {
  // Cr√≠ticos
  TOKEN_EXPIRED
  QUESTION_STUCK
  WEBHOOK_FAILED
  RATE_LIMIT_EXCEEDED
  ORG_DISCONNECTED

  // Warnings
  TOKEN_EXPIRING_SOON
  HIGH_ERROR_RATE
  SLOW_PROCESSING
  LOW_ACTIVITY

  // Info
  NEW_ORGANIZATION
  ACCOUNT_ADDED
  HIGH_VOLUME
  MILESTONE_REACHED
}

enum AlertStatus {
  ACTIVE
  RESOLVED
  DISMISSED
}

// ========== GAMIFICATION: XP & RANKING SYSTEM ==========
// Sistema de experi√™ncia e ranking para motivar vendedores
// Event-driven com WebSocket para updates em tempo real

model MLAccountXP {
  id              String    @id @default(cuid())
  mlAccountId     String    @unique

  // XP Core
  totalXP         Int       @default(0)
  level           Int       @default(1)

  // Estat√≠sticas de Performance
  questionsAnswered      Int   @default(0)
  avgResponseTimeMinutes Float @default(0)

  // Speed Stats (para achievements e c√°lculo de XP)
  ultraFastCount     Int   @default(0)  // < 5 min (DOBRO de XP!)
  fastResponsesCount Int   @default(0)  // < 30 min
  normalResponsesCount Int @default(0)  // < 1 hora

  // Streaks (sequ√™ncias motivacionais)
  currentStreak      Int   @default(0)  // Sequ√™ncia atual
  longestStreak      Int   @default(0)  // Maior sequ√™ncia j√° alcan√ßada

  // Quality Stats
  firstApprovalCount Int   @default(0)  // Aprovado sem revis√£o
  revisionCount      Int   @default(0)  // Precisou de revis√£o

  // Special Bonuses
  earlyBirdCount     Int   @default(0)  // Respostas antes 8h
  weekendCount       Int   @default(0)  // Respostas fim de semana
  lateNightCount     Int   @default(0)  // Respostas ap√≥s 22h

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastXPAt        DateTime? // √öltima vez que ganhou XP

  // Relations
  mlAccount       MLAccount @relation(fields: [mlAccountId], references: [id], onDelete: Cascade)
  activities      XPActivity[]
  achievements    Achievement[]

  // √çndices para performance de queries
  @@index([totalXP(sort: Desc)])  // Ranking ordenado
  @@index([mlAccountId])
  @@index([level])
}

model XPActivity {
  id              String    @id @default(cuid())
  mlAccountId     String

  // A√ß√£o que gerou XP
  actionType      String    // 'ultra_fast', 'fast', 'first_approval', 'streak_5', etc
  actionDescription String  // "Resposta Ultrarr√°pida em 3 min"
  xpEarned        Int

  // Contexto da a√ß√£o
  questionId      String?   // Pergunta relacionada
  responseTimeMinutes Int?  // Tempo de resposta em minutos

  // Breakdown do XP (para transpar√™ncia)
  xpBreakdown     Json?     // { baseXP, timeBonus, qualityBonus, streakBonus }

  // Timestamps
  createdAt       DateTime  @default(now())

  // Relations
  account         MLAccountXP @relation(fields: [mlAccountId], references: [mlAccountId], onDelete: Cascade)

  // √çndices otimizados
  @@index([mlAccountId, createdAt(sort: Desc)])  // √öltimas atividades da conta
  @@index([createdAt(sort: Desc)])  // Feed global de XP
  @@index([actionType])  // An√°lise por tipo
}

model Achievement {
  id              String    @id @default(cuid())
  mlAccountId     String

  // Achievement Info
  achievementType String    // 'speed_tier_1', 'ultra_speed_tier_3', etc
  achievementBaseType String @default("streak") // 'speed', 'ultra_speed', 'streak', etc
  tier            Int       @default(1) // 1-5 (Bronze, Prata, Ouro, Platina, Diamante)
  title           String    // Nome da conquista
  description     String    @db.Text

  // Recompensa
  xpRewarded      Int       // XP ganho ao desbloquear

  // Unlock info
  unlockedAt      DateTime  @default(now())

  // Relations
  account         MLAccountXP @relation(fields: [mlAccountId], references: [mlAccountId], onDelete: Cascade)

  // Garantir uma conquista por tipo por conta
  @@unique([mlAccountId, achievementType])
  @@index([mlAccountId])
  @@index([achievementType])
  @@index([achievementBaseType, tier])
  @@index([unlockedAt])
}

// ========== ADMIN: SYSTEM METRICS ==========
// M√©tricas agregadas do sistema para an√°lise no painel admin

model SystemMetric {
  id          String   @id @default(cuid())

  // Timestamp
  timestamp   DateTime @default(now())

  // Tipo de m√©trica
  category    String   // "performance", "throughput", "success_rate", "api", "workers"
  metricName  String   // "avg_processing_time", "questions_per_hour", etc
  value       Float

  // Dimens√µes (opcional)
  organizationId String?
  mlAccountId    String?
  workerId       String?

  // Metadata
  metadata    Json?

  @@index([timestamp, category])
  @@index([category, metricName])
  @@index([organizationId, timestamp])
}
